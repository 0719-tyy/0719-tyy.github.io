<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>跨期决策滴定实验（最终修正版）</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;margin:40px}
h2{margin-bottom:10px}
.option-btn{display:block;width:600px;margin:15px 0;padding:18px;font-size:18px;text-align:left;cursor:pointer}
.option-btn:hover{background:#f2f2f2}
</style>
</head>
<body>
<h2>跨期决策任务</h2>
<div id="trial"></div>
<pre id="result"></pre>

<script>
/**********************
 * 金额显示规则
 **********************/
const gainPhases = ["only gain","gain consistent","gain inconsistent"];
function moneyText(x, phase){
  if(x===0) return gainPhases.includes(phase)?"获得 0 元":"支付 0 元";
  return x>0?`获得 ${x} 元`:`支付 ${Math.abs(x)} 元`;
}

/**********************
 * 主干题目（18 条）
 **********************/
let trials = [
// only gain
{phase:"only gain",A_now:40,A_delay:0,B_now:0,B_delay:80,delay:"1个月后"},
{phase:"only gain",A_now:200,A_delay:0,B_now:0,B_delay:400,delay:"1年后"},
{phase:"only gain",A_now:600,A_delay:0,B_now:0,B_delay:1200,delay:"3年后"},
// only loss
{phase:"only loss",A_now:0,A_delay:-40,B_now:0,B_delay:-80,delay:"1个月后"},
{phase:"only loss",A_now:0,A_delay:-200,B_now:0,B_delay:-400,delay:"1年后"},
{phase:"only loss",A_now:0,A_delay:-600,B_now:0,B_delay:-1200,delay:"3年后"},
// gain consistent
{phase:"gain consistent",A_now:60,A_delay:0,B_now:100,B_delay:80,delay:"1个月后"},
{phase:"gain consistent",A_now:300,A_delay:0,B_now:500,B_delay:400,delay:"1年后"},
{phase:"gain consistent",A_now:900,A_delay:0,B_now:1500,B_delay:1200,delay:"3年后"},
// gain inconsistent
{phase:"gain inconsistent",A_now:60,A_delay:0,B_now:100,B_delay:-80,delay:"1个月后"},
{phase:"gain inconsistent",A_now:300,A_delay:0,B_now:500,B_delay:-400,delay:"1年后"},
{phase:"gain inconsistent",A_now:900,A_delay:0,B_now:1500,B_delay:-1200,delay:"3年后"},
// loss consistent
{phase:"loss consistent",A_now:0,A_delay:-100,B_now:-60,B_delay:-80,delay:"1个月后"},
{phase:"loss consistent",A_now:0,A_delay:-500,B_now:-300,B_delay:-400,delay:"1年后"},
{phase:"loss consistent",A_now:0,A_delay:-1500,B_now:-900,B_delay:-1200,delay:"3年后"},
// loss inconsistent
{phase:"loss inconsistent",A_now:0,A_delay:-100,B_now:60,B_delay:-80,delay:"1个月后"},
{phase:"loss inconsistent",A_now:0,A_delay:-500,B_now:300,B_delay:-400,delay:"1年后"},
{phase:"loss inconsistent",A_now:0,A_delay:-1500,B_now:900,B_delay:-1200,delay:"3年后"}
];

// 随机顺序
for(let i=trials.length-1;i>0;i--){
  const j=Math.floor(Math.random()*(i+1));
  [trials[i],trials[j]]=[trials[j],trials[i]];
}

let tIndex=0, step=1, maxStep=6;
let records=[];

/**********************
 * 呈现
 **********************/
function render(){
  if(tIndex>=trials.length){
    document.getElementById('trial').innerHTML='<h3>实验结束，感谢参与</h3>';
    document.getElementById('result').textContent=JSON.stringify(records,null,2);
    return;
  }
  const t=trials[tIndex];

  if(t.adjust===undefined){
    if(gainPhases.includes(t.phase)){
      t.adjust = Math.abs(Math.abs(t.B_delay) - t.A_now)/2;
    }else{
      t.adjust = Math.abs(Math.abs(t.B_delay) - Math.abs(t.A_delay))/2;
    }
  }

  document.getElementById('trial').innerHTML = `
    <p><strong>${t.phase}</strong> ｜ 第 ${step} / 6 次选择</p>
    <button class="option-btn" onclick="choose('A')">
      A：现在 ${moneyText(t.A_now,t.phase)}；${t.delay} ${moneyText(t.A_delay,t.phase)}
    </button>
    <button class="option-btn" onclick="choose('B')">
      B：现在 ${moneyText(t.B_now,t.phase)}；${t.delay} ${moneyText(t.B_delay,t.phase)}
    </button>`;
}

/**********************
 * 选择与滴定更新（最终修正）
 **********************/
function choose(choice){
  const t=trials[tIndex];
  const d=Math.abs(t.adjust);

  records.push({phase:t.phase,step,choice,A_now:t.A_now,A_delay:t.A_delay});

  // gain phases
  if(t.phase==="only gain"||t.phase==="gain consistent"||t.phase==="gain inconsistent"){
    if(choice==='A') t.A_now -= d;
    else t.A_now += d;
  }

  // only loss
  if(t.phase==="only loss"){
    if(choice==='A') t.A_delay = - (Math.abs(t.A_delay)+d);
    else t.A_delay = - (Math.abs(t.A_delay)-d);
  }

  // loss consistent
  if(t.phase==="loss consistent"){
    if(choice==='A') t.A_delay = - (Math.abs(t.A_delay)+d);
    else t.A_delay = - (Math.abs(t.A_delay)-d);
  }

  // loss inconsistent
  if(t.phase==="loss inconsistent"){
    if(choice==='A') t.A_delay = - (Math.abs(t.A_delay)+d);
    else t.A_delay = - (Math.abs(t.A_delay)-d);
  }

  t.adjust /= 2;
  step++;
  if(step>maxStep){ step=1; tIndex++; }
  render();
}

render();
</script>
</body>
</html>
