<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è·¨æœŸåå¥½å®éªŒ</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #f0f7ff, #e6f0fa);
      color: #2d3748;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      width: 100%;
      max-width: 1000px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.08);
      padding: 45px;
      text-align: center;
    }

    .page { display: none; }
    .page.active { display: block; }

    h2 {
      font-size: 26px;
      color: #2b6cb0;
      font-weight: bold;
      margin-bottom: 12px;
    }
    .progress {
      font-size: 18px;
      color: #718096;
      margin-bottom: 32px;
    }

    p, ul {
      font-size: 18px;
      line-height: 1.65;
      margin: 14px 0;
      max-width: 620px;
      margin-left: auto;
      margin-right: auto;
    }
    ul { padding-left: 24px; }

    input[type="text"] {
      font-size: 18px;
      padding: 12px 20px;
      border: 1px solid #cbd5e0;
      border-radius: 8px;
      text-align: center;
      width: 220px;
      margin-top: 16px;
    }
    input:focus {
      outline: none;
      border-color: #3182ce;
    }

    button {
      margin-top: 28px;
      padding: 12px 32px;
      font-size: 18px;
      border: none;
      border-radius: 8px;
      background: #3182ce;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover:not(:disabled) { background: #2c5aa0; }
    button:disabled {
      background: #cbd5e0;
      cursor: not-allowed;
      opacity: 0.8;
    }

    .error {
      color: #e53e3e;
      font-size: 16px;
      margin-top: 10px;
    }

    .options-container {
      display: flex;
      justify-content: space-between;
      gap: 24px;
      margin-bottom: 32px;
    }
    .option-container {
      flex: 1;
      max-width: 460px;
      text-align: center;
    }

    .option-label {
      font-size: 18px;
      color: #2b6cb0;
      font-weight: bold;
      text-align: center;
      margin-bottom: 8px;
    }

    .option-card {
      border: 1px solid #cbd5e0;
      border-radius: 12px;
      background: #f8fafc;
      padding: 24px 32px;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      height: 280px;
      display: grid;
      grid-template-rows: 1fr 1fr;
      text-align: center;
      position: relative;
    }
    .option-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    }

    .option-card::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 10%;
      right: 10%;
      height: 1px;
      background: linear-gradient(to right, transparent, #e2e8f0, transparent);
      transform: translateY(-50%);
      z-index: 1;
    }

    .time-slot {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 8px 0;
    }

    .row {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 22px;
      gap: 6px;
      white-space: nowrap;
    }
    .time-label {
      color: #4a5568;
      font-weight: 500;
    }
    .action-word {
      color: #e53e3e;
      font-weight: bold;
      font-size: 22px;
      min-width: 40px;
      text-align: center;
    }
    .amount-value {
      font-weight: bold;
      font-size: 28px;
    }
    .unit {
      color: #718096;
      font-size: 20px;
    }

    .footer-text {
      font-size: 16px;
      color: #718096;
      opacity: 0.85;
      margin-top: 22px;
    }

    #restPage h2 {
      color: #2b6cb0;
    }
    #restPage .countdown {
      font-size: 36px;
      font-weight: bold;
      color: #d97706;
      margin: 20px 0;
    }
  </style>
</head>
<body>

<div class="container">

  <!-- æ¬¢è¿é¡µ -->
  <div id="intro" class="page active">
    <h2>æ¬¢è¿æ‚¨å‚åŠ æœ¬å®éªŒï¼</h2>
    <p>æ‚¨çš„å‚ä¸å¯¹æˆ‘ä»¬çš„ç ”ç©¶éå¸¸é‡è¦ã€‚</p>
    <p>æœ¬ç ”ç©¶ä¸æ¶‰åŠé£é™©ï¼Œæ‰€æœ‰ä¿¡æ¯ä¸¥æ ¼ä¿å¯†ï¼Œå›ç­”å°†åŒ¿åä¿å­˜ã€‚</p>
    <ul>
      <li>å‰ <strong>6 é“ä¸ºç»ƒä¹ é¢˜</strong>ï¼ˆç”¨äºç†Ÿæ‚‰ä»»åŠ¡ï¼‰ï¼›</li>
      <li>éšåæ˜¯ <strong>æ­£å¼é¢˜ç›®</strong>ï¼ˆå…±111é¢˜ï¼ŒåŒ…å«è‹¥å¹²æ³¨æ„åŠ›æ£€æµ‹é¢˜ï¼‰ï¼›</li>
      <li>ä¸ºé˜²æ­¢å®éªŒç–²åŠ³ï¼Œæœ¬ç ”ç©¶è®¾ç½®ä¸¤æ¬¡å¼ºåˆ¶çš„ç»„é—´ä¼‘æ¯ï¼›</li>
      <li>è¯·æ‚¨è®¤çœŸä½œç­”ï¼Œæœªé€šè¿‡æ£€æµ‹é¢˜æˆ–è§„å¾‹ä½œç­”å°†ä¸å‘æ”¾å®éªŒæŠ¥é…¬ã€‚</li>
      <li>å®éªŒç»“æŸåï¼Œè¯·å°†æ•°æ®ä¸‹è½½å¹¶ä¸Šä¼ è‡³2537695699@qq.comã€‚</li>
    </ul>
    <p><strong>ä»»åŠ¡è¯´æ˜ï¼š</strong><br>
       å±å¹•ä¸Šå°†å‡ºç°ä¸¤ä¸ªé€‰é¡¹ï¼Œæ¯ä¸ªé€‰é¡¹åŒ…å«â€œç°åœ¨â€å’Œâ€œæœªæ¥â€çš„é‡‘é¢å˜åŠ¨ã€‚<br>
       é€‰é¡¹æ²¡æœ‰å¯¹é”™ä¹‹åˆ†ï¼Œè¯·ç‚¹å‡»æ‚¨æ›´åå¥½çš„é€‰é¡¹ã€‚
       <br>è¯·è¾“å…¥å”¯ä¸€å®éªŒç¼–å·ï¼ˆåå­—é¦–å­—æ¯+å››ä½æ—¶é—´æ•°ï¼‰ï¼Œä¾‹å¦‚LXM2334<br>
    </p>

    <input type="text" id="pid" placeholder="ä¾‹å¦‚:LMX2334">
    <div id="idError" class="error"></div>
    <button onclick="startExperiment()">å¼€å§‹ç»ƒä¹ </button>
  </div>

  <!-- ç»ƒä¹ ç»“æŸè¿‡æ¸¡é¡µ -->
  <div id="transition" class="page">
    <h2>ç»ƒä¹ é˜¶æ®µå·²å®Œæˆï¼</h2>
    <p>æ‚¨å·²ç†Ÿæ‚‰å®éªŒæµç¨‹ã€‚</p>
    <p>æ¥ä¸‹æ¥å°†è¿›å…¥æ­£å¼å®éªŒï¼Œè¯·æ‚¨è®¤çœŸä½œç­”ã€‚</p>
    <button onclick="startFormalExperiment()">å¼€å§‹æ­£å¼å®éªŒ</button>
  </div>

  <!-- ä¼‘æ¯é¡µ -->
  <div id="restPage" class="page">
    <h2>æ‚¨å·²å®Œæˆä¸€ä¸ªç»„å—çš„é¢˜ç›®ï¼Œè¯·ä¼‘æ¯ 1 åˆ†é’Ÿ</h2>
    <p>ä¸ºä¿è¯å®éªŒè´¨é‡ï¼Œè¯·ç¨ä½œä¼‘æ¯ï¼Œæ”¾æ¾çœ¼ç›ã€‚</p>
    <div class="countdown" id="restCountdown">60</div>
    <p>ä¼‘æ¯æ—¶é—´ç»“æŸåï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç»§ç»­å®éªŒã€‚</p>
    <button id="continueBtn" style="display:none;" onclick="resumeAfterRest()">ç»§ç»­å®éªŒ</button>
  </div>

  <!-- å®éªŒä¸»ç•Œé¢ -->
  <div id="experiment" class="page">
    <h2>è¯·æ ¹æ®æ‚¨çš„çœŸå®æ„Ÿå—ç‚¹å‡»æ‚¨æ›´åå¥½çš„é€‰é¡¹</h2>
    <div id="progressText" class="progress">è¿›åº¦ï¼š1 / 111</div>

    <div class="options-container">
      <div class="option-container">
        <div class="option-label">é€‰é¡¹ A</div>
        <div class="option-card" id="optLeft" onclick="chooseOption('left')"></div>
      </div>
      <div class="option-container">
        <div class="option-label">é€‰é¡¹ B</div>
        <div class="option-card" id="optRight" onclick="chooseOption('right')"></div>
      </div>
    </div>

    <div class="footer-text">(ç‚¹å‡»é€‰é¡¹å³å¯è‡ªåŠ¨è¿›å…¥ä¸‹ä¸€é¢˜)</div>
  </div>

  <!-- ç»“æŸé¡µ -->
  <div id="finish" class="page">
    <h2>å…¨éƒ¨å®éªŒå·²å®Œæˆï¼</h2>
    <p>æ„Ÿè°¢æ‚¨çš„è®¤çœŸå‚ä¸ï¼</p>
    <p><strong>è¯·ä¸‹è½½å®éªŒæ•°æ®å¹¶å‘é€è‡³2537695699@qq.com</strong></p>
    <button onclick="downloadData()">ä¸‹è½½é€‰æ‹©ç»“æœä¸å…ƒæ•°æ®</button>
  </div>

</div>

<script>
// ==================== å…¨å±€å˜é‡ ====================
let subjectId = '';
const PHASES = [
  'only gain',
  'only loss',
  'gain consistent',
  'gain inconsistent',
  'loss consistent',
  'loss inconsistent'
];

const CONFIG = {
  'only gain': [[40, 0, 0, 80], [200, 0, 0, 400], [600, 0, 0, 1200]],
  'only loss': [[-40, 0, 0, -80], [-200, 0, 0, -400], [-600, 0, 0, -1200]],
  'gain consistent': [[60, 0, 100, 80], [300, 0, 500, 400], [900, 0, 1500, 1200]],
  'gain inconsistent': [[60, 0, 100, -80], [300, 0, 500, -400], [900, 0, 1500, -1200]],
  'loss consistent': [[-100, 0, -60, -80], [-500, 0, -300, -400], [-1500, 0, -900, -1200]],
  'loss inconsistent': [[-100, 0, 60, -80], [-500, 0, 300, -400], [-1500, 0, 900, -1200]]
};

let allConditions = [];
let conditionSequence = [];
let groupIndex = 0; // 0 ~ 17 (18 groups Ã— 6 trials = 108)
let trialsInCurrentGroup = 0;

let completedTrials = 0;
const TOTAL_FORMAL_TRIALS = 108;
const TOTAL_ATTENTION_CHECKS = 3;
const TOTAL_TRIALS = TOTAL_FORMAL_TRIALS + TOTAL_ATTENTION_CHECKS;

let startTime = null;
let A_now = 0, A_delay = 0, B_now = 0, B_delay = 0, phase = '', delayLabel = '';

// æ»´å®šçŠ¶æ€
let initial_A = 0;
let current_A = 0;
let step = 0;
let lastChoice = null;
let hasReversed = false;
let accepted = null;
let rejected = null;
let A_now_history = [];

let isPractice = false;
let practiceTrials = [];
let practiceTrialIndex = 0;

let allData = [];

// âœ… å…³é”®ä¿®å¤1ï¼šè¡¥å…¨ç¼ºå¤±å˜é‡
let positionSequence = []; // ç”¨äºè®°å½•æ¯ç»„6é¢˜çš„å·¦å³ä½ç½®åºåˆ—

// ==================== å·¥å…·å‡½æ•° ====================
function shuffleArray(array) {
  for (let i = array.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

function getDelayText(label) {
  return label === '1 month' ? '1ä¸ªæœˆå' :
         label === '1 year'  ? '1å¹´å'  :
                                '3å¹´å';
}

function generateAllConditions() {
  const delays = ['1 month', '1 year', '3 years'];
  let conditions = [];
  for (let p of PHASES) {
    for (let d = 0; d < 3; d++) {
      conditions.push({ phase: p, delayIndex: d, delayLabel: delays[d] });
    }
  }
  return shuffleArray(conditions);
}

function generatePracticeTrials() {
  const baseAmounts = [30, 50, 70, 100, 150, 200];
  practiceTrials = baseAmounts.map(amount => ({
    A_now: amount,
    A_delay: 0,
    B_now: 0,
    B_delay: amount * 2,
    delayLabel: '1 month'
  }));
  shuffleArray(practiceTrials);
}

function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
}

// ==================== ä¼‘æ¯æ§åˆ¶ ====================
function startRestPeriod() {
  showPage('restPage');
  let timeLeft = 60;
  document.getElementById('restCountdown').textContent = timeLeft;
  document.getElementById('continueBtn').style.display = 'none';

  const timer = setInterval(() => {
    timeLeft--;
    document.getElementById('restCountdown').textContent = timeLeft;
    if (timeLeft <= 0) {
      clearInterval(timer);
      document.getElementById('continueBtn').style.display = 'inline-block';
    }
  }, 1000);
}

function resumeAfterRest() {
  loadNextTrial();
}

// ==================== é¡µé¢æ§åˆ¶ ====================
function startExperiment() {
  const input = document.getElementById('pid').value.trim();
  const errorDiv = document.getElementById('idError');
  errorDiv.textContent = '';

  if (input === '') {
    errorDiv.textContent = 'âŒ è¯·è¾“å…¥ä¸€ä¸ªå®éªŒç¼–å·ï¼ˆä¸èƒ½ä¸ºç©ºï¼‰';
    return;
  }

  subjectId = input.replace(/[^a-zA-Z0-9_\-]/g, '').substring(0, 30) || 'participant';
  startPractice();
}

function startPractice() {
  isPractice = true;
  practiceTrialIndex = 0;
  generatePracticeTrials();
  loadPracticeTrial();
  showPage('experiment');
}

function loadPracticeTrial() {
  if (practiceTrialIndex >= practiceTrials.length) {
    showPage('transition');
    return;
  }

  const trial = practiceTrials[practiceTrialIndex];
  A_now = trial.A_now;
  A_delay = trial.A_delay;
  B_now = trial.B_now;
  B_delay = trial.B_delay;
  delayLabel = trial.delayLabel;
  phase = 'practice';

  document.getElementById('experiment').querySelector('h2').textContent = 'è¿™æ˜¯ç»ƒä¹ é¢˜ï¼Œè¯·æ ¹æ®æ‚¨çš„åå¥½é€‰æ‹©ã€‚';
  document.getElementById('progressText').textContent = `ç»ƒä¹  ç¬¬ ${practiceTrialIndex + 1} é¢˜ï¼ˆå…± 6 é¢˜ï¼‰`;

  renderOptions();
}

function startFormalExperiment() {
  isPractice = false;
  completedTrials = 0;
  allData = [];
  groupIndex = 0;
  trialsInCurrentGroup = 0;

  allConditions = generateAllConditions();
  conditionSequence = [...allConditions];

  loadNextTrial();
  showPage('experiment');
}

// ==================== æ³¨æ„åŠ›æ£€æµ‹ ====================
function getAttentionDelay(groupIdx) {
  if (groupIdx === 2) return '1 month';
  if (groupIdx === 8) return '1 year';
  if (groupIdx === 14) return '3 years';
  return '1 month';
}

function loadAttentionCheck() {
  phase = 'attention_check';
  delayLabel = getAttentionDelay(groupIndex);

  A_now = 100;
  A_delay = 100;
  B_now = -500;
  B_delay = -500;

  document.getElementById('experiment').querySelector('h2').textContent =
    'è¿™é“é¢˜ç”¨äºæ£€éªŒæ˜¯å¦è®¤çœŸä½œç­”ï¼Œè¯·é€‰æ‹©é€‰é¡¹Aã€‚';

  renderOptions();
  document.getElementById('progressText').textContent = `è¿›åº¦ï¼š${completedTrials + 1} / ${TOTAL_TRIALS}`;
  startTime = performance.now();
}

// ==================== æ ¸å¿ƒï¼šåŠ è½½ä¸‹ä¸€é¢˜ï¼ˆå«ä¼‘æ¯è§¦å‘ï¼‰====================
function loadNextTrial() {
  // æ£€æŸ¥æ˜¯å¦åˆšå®Œæˆä¸€ç»„ï¼ˆ6é¢˜ï¼‰
  if (trialsInCurrentGroup === 6) {
    groupIndex++;
    trialsInCurrentGroup = 0;

    // ğŸ‘‡ åœ¨ç¬¬6ç»„ï¼ˆ36é¢˜ï¼‰ã€ç¬¬12ç»„ï¼ˆ72é¢˜ï¼‰å®Œæˆåè§¦å‘ä¼‘æ¯
    if (groupIndex === 6 || groupIndex === 12) {
      startRestPeriod();
      return;
    }

    // æ’å…¥æ³¨æ„åŠ›æ£€æµ‹é¢˜
    const shouldInsertAttention = [2, 8, 14].includes(groupIndex);
    if (shouldInsertAttention) {
      loadAttentionCheck();
      return;
    }

    if (groupIndex >= 18) {
      showPage('finish');
      return;
    }
  }

  // åˆå§‹åŒ–æ–°ç»„çš„æ»´å®šå‚æ•°
  if (trialsInCurrentGroup === 0) {
    const cond = conditionSequence[groupIndex];
    phase = cond.phase;
    delayLabel = cond.delayLabel;
    const delayIndex = cond.delayIndex;

    const config = CONFIG[phase][delayIndex];
    A_delay = config[1]; // é€šå¸¸æ˜¯ 0
    B_now = config[2];   // é€šå¸¸æ˜¯ 0
    B_delay = config[3];

    initial_A = config[0];
    current_A = initial_A;
    step = Math.abs(initial_A) / 2;
    lastChoice = null;
    hasReversed = false;
    accepted = null;
    rejected = null;
    A_now_history = [];

    positionSequence = ['left', 'left', 'left', 'right', 'right', 'right'];
    shuffleArray(positionSequence);
  }

  A_now = current_A;

  if (!isPractice) {
    document.getElementById('progressText').textContent = `è¿›åº¦ï¼š${completedTrials + 1} / ${TOTAL_TRIALS}`;
    document.getElementById('experiment').querySelector('h2').textContent = 'è¯·æ ¹æ®æ‚¨çš„çœŸå®æ„Ÿå—ç‚¹å‡»æ‚¨æ›´åå¥½çš„é€‰é¡¹';
  }

  startTime = performance.now();
  renderOptions();
}

// ==================== æ¸²æŸ“é€‰é¡¹ ====================
function buildOptionHtml(nowVal, delayVal, timeLabel) {
  function getAction(val) {
    return val >= 0 ? 'è·å¾—' : 'æ”¯ä»˜';
  }
  function getAbs(val) {
    return Math.abs(val);
  }
  return `
    <div class="time-slot">
      <div class="row">
        <span class="time-label">ç°åœ¨</span>
        <span class="action-word">${getAction(nowVal)}</span>
        <span class="amount-value">${getAbs(nowVal)}</span>
        <span class="unit">å…ƒ</span>
      </div>
    </div>
    <div class="time-slot">
      <div class="row">
        <span class="time-label">${timeLabel}</span>
        <span class="action-word">${getAction(delayVal)}</span>
        <span class="amount-value">${getAbs(delayVal)}</span>
        <span class="unit">å…ƒ</span>
      </div>
    </div>
  `;
}

function renderOptions() {
  const delayText = getDelayText(delayLabel);
  const pos = positionSequence[trialsInCurrentGroup];
  let leftHtml, rightHtml;

  if (pos === 'left') {
    leftHtml = buildOptionHtml(A_now, A_delay, delayText);
    rightHtml = buildOptionHtml(B_now, B_delay, delayText);
  } else {
    leftHtml = buildOptionHtml(B_now, B_delay, delayText);
    rightHtml = buildOptionHtml(A_now, A_delay, delayText);
  }

  document.getElementById('optLeft').innerHTML = leftHtml;
  document.getElementById('optRight').innerHTML = rightHtml;

  document.querySelector('.option-container:nth-child(1) .option-label').textContent = "é€‰é¡¹ A";
  document.querySelector('.option-container:nth-child(2) .option-label').textContent = "é€‰é¡¹ B";
}

// ==================== é€‰æ‹©å¤„ç† ====================
function chooseOption(side) {
  if (isPractice) {
    practiceTrialIndex++;
    loadPracticeTrial();
    return;
  }

  if (phase === 'attention_check') {
    const clickedIsLeft = (side === 'left');
    const choice = clickedIsLeft ? 'A' : 'B';
    const rt = (performance.now() - startTime) / 1000;
    const isCorrect = (choice === 'A');

    allData.push({
      subject_id: subjectId,
      phase: 'attention_check',
      delay_time: delayLabel,
      trial: completedTrials + 1,
      A_now: 100,
      A_delay: 100,
      B_now: -500,
      B_delay: -500,
      choice,
      reaction_time_sec: rt.toFixed(3),
      is_reversal: false,
      block_index: Math.floor(groupIndex / 6) + 1,
      indifference_estimate: '',
      is_attention: true,
      attention_correct: isCorrect
    });

    completedTrials++;
    loadNextTrial();
    return;
  }

  const pos = positionSequence[trialsInCurrentGroup];
  const choice = (pos === 'left') ? (side === 'left' ? 'A' : 'B') : (side === 'left' ? 'B' : 'A');

  handleChoice(choice);
}

function handleChoice(choice) {
  const rt = (performance.now() - startTime) / 1000;
  A_now_history.push(current_A);

  const isReversal = (lastChoice !== null && lastChoice !== choice);
  if (isReversal && !hasReversed) {
    hasReversed = true;
    if (lastChoice === 'A') {
      accepted = A_now_history[A_now_history.length - 2];
      rejected = current_A;
    } else {
      rejected = A_now_history[A_now_history.length - 2];
      accepted = current_A;
    }
  }

  if (choice === 'A') {
    current_A = current_A - step;
  } else {
    current_A = current_A + step;
  }

  if (isReversal) {
    step = step / 2;
  }

  const actual_A_now = A_now_history[A_now_history.length - 1];

  allData.push({
    subject_id: subjectId,
    phase,
    delay_time: delayLabel,
    trial: completedTrials + 1,
    A_now: actual_A_now,
    A_delay,
    B_now,
    B_delay,
    choice,
    reaction_time_sec: rt.toFixed(3),
    is_reversal: isReversal,
    block_index: Math.floor(groupIndex / 6) + 1,
    is_attention: false
  });

  lastChoice = choice;
  trialsInCurrentGroup++;
  completedTrials++;

  if (trialsInCurrentGroup >= 6) {
    let indifference_estimate = '';
    if (accepted !== null && rejected !== null) {
      indifference_estimate = ((accepted + rejected) / 2).toFixed(2);
    } else {
      indifference_estimate = (actual_A_now).toFixed(2);
    }

    const startIndex = allData.length - 6;
    for (let i = startIndex; i < allData.length; i++) {
      allData[i].indifference_estimate = indifference_estimate;
    }
  }

  setTimeout(() => {
    loadNextTrial();
  }, 100);
}

// ==================== æ•°æ®å¯¼å‡º ====================
function downloadData() {
  const header = [
    "subject_id",
    "phase",
    "delay_time",
    "trial",
    "A_now",
    "A_delay",
    "B_now",
    "B_delay",
    "choice",
    "reaction_time_sec",
    "is_reversal",
    "block_index",
    "indifference_estimate",
    "is_attention",
    "attention_correct"
  ].join(",");

  const rows = allData.map(e => {
    return [
      e.subject_id,
      e.phase,
      e.delay_time,
      e.trial,
      e.A_now,
      e.A_delay,
      e.B_now,
      e.B_delay,
      e.choice,
      e.reaction_time_sec,
      e.is_reversal,
      e.block_index,
      e.indifference_estimate || '',
      e.is_attention ? 'true' : 'false',
      e.attention_correct !== undefined ? (e.attention_correct ? 'true' : 'false') : ''
    ].join(",");
  }).join("\n");

  const csvContent = "data:text/csv;charset=utf-8,\uFEFF" + header + "\n" + rows;
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", `${subjectId}_experiment_data.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}
</script>
</body>
</html>
