<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ—¶é—´åå¥½æ»´å®šå®éªŒ</title>
  <style>
    body {
      font-family: "Microsoft YaHei", sans-serif;
      background-color: #f9f9f9;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    .hidden { display: none; }
    .instruction-page {
      text-align: center;
      padding: 40px 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .instruction-page h2 {
      color: #007bff;
      margin-bottom: 20px;
    }
    .instruction-page p {
      line-height: 1.6;
      margin: 15px 0;
      color: #444;
    }
    input#subjectId {
      padding: 10px;
      font-size: 18px;
      width: 220px;
      text-align: center;
      margin: 15px 0;
      border: 2px solid #ccc;
      border-radius: 5px;
    }
    input#subjectId:focus {
      border-color: #007bff;
      outline: none;
    }
    .hint {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    .error {
      color: #dc3545;
      font-size: 14px;
      margin-top: 5px;
    }
    button.start-btn {
      display: block;
      margin: 20px auto;
      padding: 12px 30px;
      font-size: 18px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button.start-btn:hover {
      background: #218838;
    }

    /* å®éªŒä¸»ç•Œé¢æ ·å¼ */
    .instruction {
      text-align: center;
      margin-bottom: 20px;
      color: #333;
    }
    .trial-info {
      text-align: center;
      margin-bottom: 15px;
      font-size: 16px;
      color: #555;
    }
    .options {
      display: flex;
      justify-content: space-around;
      gap: 30px;
      margin: 30px 0;
    }
    .option {
      width: 40%;
      padding: 20px;
      background: white;
      border: 2px solid #ccc;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }
    .option:hover {
      border-color: #007bff;
      background-color: #f0f8ff;
    }
    .option h3 {
      margin: 0 0 15px;
      color: #007bff;
    }
    .amount {
      font-size: 20px;
      font-weight: bold;
      margin: 8px 0;
    }
    .now { color: #28a745; }
    .delay { color: #dc3545; }
    #results {
      margin-top: 30px;
      text-align: center;
      font-size: 18px;
      color: #28a745;
    }
    button.task-btn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      background: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button.task-btn:hover { background: #218838; }
  </style>
</head>
<body>

<!-- æŒ‡å¯¼è¯­ç•Œé¢ -->
<div id="welcomePage" class="instruction-page">
  <h2>æ—¶é—´åå¥½å†³ç­–å®éªŒ</h2>
  <p>æ¬¢è¿æ‚¨å‚ä¸æœ¬æ¬¡å¿ƒç†å­¦å®éªŒï¼</p>
  <p>æœ¬å®éªŒåŒ…å«å¤šä¸ªå†³ç­–ä»»åŠ¡ï¼Œæ‚¨éœ€è¦åœ¨â€œç°åœ¨è·å¾—/æŸå¤±é‡‘é¢â€å’Œâ€œæœªæ¥è·å¾—/æŸå¤±é‡‘é¢â€ä¹‹é—´åšå‡ºé€‰æ‹©ã€‚</p>
  <p>è¯·æ ¹æ®æ‚¨çš„çœŸå®åå¥½è¿›è¡Œé€‰æ‹©ã€‚</p>

  <p><strong>è¯·è¾“å…¥æ‚¨çš„å®éªŒç¼–å·ï¼ˆç”¨äºä¿å­˜æ•°æ®ï¼‰ï¼š</strong></p>
  <input type="text" id="subjectId" maxlength="20" placeholder="ä¾‹å¦‚ï¼šLXM1745 ">
  <div class="hint">å»ºè®®æ ¼å¼ï¼šå§“åé¦–å­—æ¯ + 4ä½æ—¶é—´æ•°ï¼ˆå¦‚1745ï¼‰</div>
  <div id="idError" class="error"></div>

  <button class="start-btn" onclick="startExperiment()">å¼€å§‹å®éªŒ</button>
</div>

<!-- å®éªŒä¸»ç•Œé¢ -->
<div id="experimentPage" class="hidden">
  <div class="instruction">
    <h2>æ—¶é—´åå¥½å†³ç­–ä»»åŠ¡</h2>
    <p>è¯·é€‰æ‹©æ‚¨æ›´åå¥½çš„é€‰é¡¹ï¼ˆA æˆ– Bï¼‰ï¼š</p>
  </div>

  <div class="trial-info" id="trialInfo"></div>

  <div class="options" id="optionsContainer">
    <div class="option" id="optionA" onclick="choose('A')">
      <h3>é€‰é¡¹ A</h3>
      <div class="amount now" id="aNow"></div>
      <div class="amount delay" id="aDelay"></div>
    </div>
    <div class="option" id="optionB" onclick="choose('B')">
      <h3>é€‰é¡¹ B</h3>
      <div class="amount now" id="bNow"></div>
      <div class="amount delay" id="bDelay"></div>
    </div>
  </div>

  <button id="nextBtn" class="task-btn hidden" onclick="nextCondition()">ç»§ç»­ä¸‹ä¸€ç»„</button>
  <div id="results" class="hidden"></div>
</div>

<script>
// ==================== å…¨å±€å˜é‡ ====================
let subjectId = '';
const PHASES = [
  'only gain',
  'only loss',
  'gain consistent',
  'gain inconsistent',
  'loss consistent',
  'loss inconsistent'
];

const CONFIG = {
  'only gain': [[40, 0, 0, 80], [200, 0, 0, 400], [600, 0, 0, 1200]],
  'only loss': [[-40, 0, 0, -80], [-200, 0, 0, -400], [-600, 0, 0, -1200]],
  'gain consistent': [[60, 0, 100, 80], [300, 0, 500, 400], [900, 0, 1500, 1200]],
  'gain inconsistent': [[60, 0, 100, -80], [300, 0, 500, -400], [900, 0, 1500, -1200]],
  'loss consistent': [[-100, 0, -60, -80], [-500, 0, -300, -400], [-1500, 0, -900, -1200]],
  'loss inconsistent': [[-100, 0, 60, -80], [-500, 0, 300, -400], [-1500, 0, 900, -1200]]
};

// å®éªŒçŠ¶æ€
let currentPhaseIndex = 0;
let currentDelayIndex = 0;
let trialCount = 0;
let startTime = null;
let A_now = 0, A_delay = 0, B_now = 0, B_delay = 0, phase = '', delayLabel = '';
let initial_A = 0, step = 0, lastChoice = null, hasReversed = false;
let accepted = null, rejected = null;
let allData = [], A_now_history = [];

// ==================== å¼€å§‹å®éªŒ ====================
function startExperiment() {
  const input = document.getElementById('subjectId').value.trim();
  const errorDiv = document.getElementById('idError');
  errorDiv.textContent = '';

  if (input === '') {
    errorDiv.textContent = 'âŒ è¯·è¾“å…¥ä¸€ä¸ªå®éªŒç¼–å·ï¼ˆä¸èƒ½ä¸ºç©ºï¼‰';
    return;
  }

  // æ¸…ç†æ–‡ä»¶åï¼šåªä¿ç•™å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ï¼Œæœ€å¤š30å­—ç¬¦
  subjectId = input.replace(/[^a-zA-Z0-9_\-]/g, '').substring(0, 30) || 'participant';

  // åˆ‡æ¢ç•Œé¢
  document.getElementById('welcomePage').classList.add('hidden');
  document.getElementById('experimentPage').classList.remove('hidden');

  initCondition();
}

// ==================== åŸæœ‰å®éªŒé€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰ ====================
function initCondition() {
  phase = PHASES[currentPhaseIndex];
  const delays = ['1 month', '1 year', '3 years'];
  delayLabel = delays[currentDelayIndex];

  [A_now, A_delay, B_now, B_delay] = CONFIG[phase][currentDelayIndex].map(x => parseFloat(x));
  initial_A = A_now;
  step = Math.abs(initial_A) / 2;

  trialCount = 0;
  lastChoice = null;
  hasReversed = false;
  accepted = null;
  rejected = null;
  A_now_history = [];

  updateDisplay();
}

function updateDisplay() {
  document.getElementById('aNow').textContent = `ç°åœ¨: ${formatAmount(A_now)}`;
  document.getElementById('aDelay').textContent = `${getDelayText()}: ${formatAmount(A_delay)}`;
  document.getElementById('bNow').textContent = `ç°åœ¨: ${formatAmount(B_now)}`;
  document.getElementById('bDelay').textContent = `${getDelayText()}: ${formatAmount(B_delay)}`;

  document.getElementById('trialInfo').textContent =
    `é˜¶æ®µ: ${phase} | å»¶è¿Ÿ: ${delayLabel} | ç¬¬ ${trialCount + 1}/6 æ¬¡é€‰æ‹©`;

  startTime = performance.now();
}

function formatAmount(val) {
  return val >= 0 ? `+${val}` : `${val}`;
}

function getDelayText() {
  return delayLabel === '1 month' ? '1ä¸ªæœˆå' :
         delayLabel === '1 year'  ? '1å¹´å'  :
                                    '3å¹´å';
}

function choose(choice) {
  const rt = (performance.now() - startTime) / 1000;
  A_now_history.push(A_now);

  allData.push({
    subject_id: subjectId,
    phase,
    delay_time: delayLabel,
    trial: trialCount + 1,
    A_now,
    A_delay,
    B_now,
    B_delay,
    choice,
    reaction_time_sec: rt.toFixed(3),
    is_reversal: false
  });

  const isReversal = (lastChoice !== null && lastChoice !== choice);
  if (isReversal && !hasReversed) {
    hasReversed = true;
    if (lastChoice === 'A') {
      accepted = A_now_history[trialCount - 1];
      rejected = A_now;
    } else {
      rejected = A_now_history[trialCount - 1];
      accepted = A_now;
    }
    allData[allData.length - 1].is_reversal = true;
  }

  if (choice === 'A') accepted = A_now;
  else rejected = A_now;

  lastChoice = choice;
  trialCount++;

  if (trialCount >= 6) {
    finishCondition();
    return;
  }

  if (!hasReversed) {
    if (['only gain', 'gain consistent', 'gain inconsistent'].includes(phase)) {
      A_now = choice === 'A' ? A_now - step : A_now + step;
    } else {
      A_now = choice === 'A' ? A_now - step : A_now + step;
    }
    step /= 2;
  } else {
    if (accepted !== null && rejected !== null) {
      A_now = (accepted + rejected) / 2;
    }
  }

  updateDisplay();
}

function finishCondition() {
  let indifference_estimate;
  if (hasReversed && accepted !== null && rejected !== null) {
    indifference_estimate = ((accepted + rejected) / 2).toFixed(2);
  } else {
    indifference_estimate = A_now.toFixed(2);
  }

  const startIndex = allData.length - 6;
  for (let i = startIndex; i < allData.length; i++) {
    allData[i].indifference_estimate = indifference_estimate;
  }

  document.getElementById('optionsContainer').classList.add('hidden');
  document.getElementById('trialInfo').textContent = `âœ… å®Œæˆï¼š${phase} - ${delayLabel}`;

  let nextDelayIndex = currentDelayIndex + 1;
  let nextPhaseIndex = currentPhaseIndex;
  if (nextDelayIndex >= 3) {
    nextDelayIndex = 0;
    nextPhaseIndex++;
  }

  if (nextPhaseIndex >= PHASES.length) {
    downloadResults();
  } else {
    document.getElementById('nextBtn').classList.remove('hidden');
  }
}

function nextCondition() {
  document.getElementById('optionsContainer').classList.remove('hidden');
  document.getElementById('nextBtn').classList.add('hidden');

  currentDelayIndex++;
  if (currentDelayIndex >= 3) {
    currentDelayIndex = 0;
    currentPhaseIndex++;
  }
  initCondition();
}

function downloadResults() {
  let csv = "subject_id,phase,delay_time,trial,A_now,A_delay,B_now,B_delay,choice,reaction_time_sec,is_reversal,indifference_estimate\n";
  allData.forEach(r => {
    csv += `"${r.subject_id}","${r.phase}",${r.delay_time},${r.trial},${r.A_now},${r.A_delay},${r.B_now},${r.B_delay},${r.choice},${r.reaction_time_sec},${r.is_reversal},${r.indifference_estimate}\n`;
  });

  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);

  // å®‰å…¨çš„æ–‡ä»¶åï¼ˆå·²æ¸…ç†ï¼‰
  const filename = `${subjectId}_time_preference_data.csv`;

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  document.getElementById('trialInfo').textContent = "ğŸ‰ å®éªŒå·²å®Œæˆï¼æ•°æ®å·²è‡ªåŠ¨ä¸‹è½½ã€‚";
  document.getElementById('results').classList.remove('hidden');
  document.getElementById('results').textContent = "æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼";
}
</script>

</body>
</html>
