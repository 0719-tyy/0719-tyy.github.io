<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>跨期选择实验</title>
  <style>
    body {
      font-family: "Microsoft YaHei", "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #f0f7ff, #e6f0fa);
      margin: 0;
      padding: 0;
      color: #2d3748;
    }

    .container-box {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      text-align: center;
      padding: 40px;
      box-sizing: border-box;
    }

    #intro {
      background: white;
      max-width: 1000px;
      margin: 40px auto;
      padding: 50px;
      border-radius: 20px;
      box-shadow: 0 0 30px rgba(0,0,0,0.08);
    }
    #intro h2 { font-size: 28px; color: #1a365d; margin-bottom: 20px; }
    #intro p, #intro ul { font-size: 22px; line-height: 1.7; margin: 12px 0; max-width: 800px; text-align: left; }
    #intro ul { margin-left: auto; margin-right: auto; padding-left: 40px; }

    input[type="text"] {
      font-size: 22px;
      padding: 12px 20px;
      border: 2px solid #cbd5e0;
      border-radius: 10px;
      text-align: center;
      width: 200px;
      margin-top: 20px;
    }

    button {
      margin-top: 30px;
      padding: 14px 40px;
      font-size: 22px;
      border: none;
      border-radius: 12px;
      background: #3182ce;
      color: white;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.2s;
    }
    button:hover { background: #2c5aa0; }
    button:disabled { background: #cbd5e0; cursor: not-allowed; }

    #transition, #finish, #rest {
      display: none;
      background: white;
      max-width: 900px;
      margin: 60px auto;
      padding: 50px;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      text-align: center;
    }
    #transition h2,
    #finish h2,
    #rest h2 {
      font-size: 32px;
      color: #1a365d;
      margin-bottom: 20px;
    }
    #transition p,
    #finish p,
    #rest p {
      font-size: 24px;
      line-height: 1.6;
      margin: 12px 0;
      color: #2d3748;
    }
    #finish p strong {
      color: #e53e3e;
    }
    #countdownText {
      font-size: 28px;
      font-weight: bold;
      color: #2b6cb0;
    }

    #experimentContainer {
      display: none;
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .panel {
      background: white;
      padding: 40px;
      border-radius: 20px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    .question-header {
      text-align: center;
      margin-bottom: 40px;
    }
    #instructionText {
      font-size: 26px;
      color: #2b6cb0;
      font-weight: bold;
    }
    #progressText {
      font-size: 20px;
      color: #718096;
      margin-top: 10px;
    }

    .options-container {
      display: flex;
      justify-content: space-between;
      gap: 40px;
      margin-top: 20px;
    }

    .option-container {
      flex: 1;
      max-width: 500px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .option {
      flex: 1;
      background: #f8fafc;
      border: 3px solid #cbd5e0;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 30px 10px;
      min-height: 200px;
      width: 100%;
    }
    .option:hover {
      background: #edf2f7;
      border-color: #a0aec0;
      transform: translateY(-4px);
    }
    .option.selected {
      border-color: #38a169;
      background: #f0fff4;
      box-shadow: 0 6px 16px rgba(68, 189, 127, 0.25);
    }

    .option-row {
      font-size: 24px;
      line-height: 1.5;
      width: 100%;
      text-align: center;
      padding: 15px 0;
    }
    .option-row.top {
      border-bottom: 2px dashed #e2e8f0;
      margin-bottom: 10px;
    }
    .option-row.bottom {
      margin-top: 10px;
    }

    .highlight-keyword {
      font-weight: bold;
      color: #e53e3e;
      font-size: 1.1em;
    }
    .amount-text {
      font-weight: bold;
      margin: 0 5px;
    }

    .label {
      font-size: 20px;
      color: #2b6cb0;
      margin-bottom: 5px;
      font-weight: bold;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="intro" class="container-box" style="min-height:auto;">
  <h2>欢迎您参加本实验！</h2>
  <p>您的参与对我们的研究非常重要。</p>
  <p>本研究不涉及风险，所有信息严格保密，回答将匿名保存。</p>
  <ul style="list-style-type: disc;">
    <li>前 <strong>6 道为练习题</strong>（用于熟悉任务）；</li>
    <li>随后是 <strong>正式题目</strong>（数据将被记录）；</li>
    <li>实验结束后，请将实验数据下载并上传到本问卷“选择文件”端口，收到数据后将第一时间审核问卷为您发放实验报酬。</li>
  </ul>
  <p><strong>任务说明：</strong><br>
     屏幕上将出现左右两个选项。每个选项包含两个时间点的金额变动（上方为“现在”，下方为“未来”）。<br>
     请仔细观看，点击您更偏好的选项，然后系统会自动进入下一题。
  </p>

  <br>
  <label for="pid" style="font-size:22px;">请随机输入您偏好的编号：</label><br>
  <input type="text" id="pid" placeholder="例如: 001">

  <button onclick="startExperiment()">开始练习</button>
</div>

<div id="transition">
  <h2>练习阶段已完成！</h2>
  <p>您已熟悉实验流程。</p>
  <p><strong>接下来将进入正式实验环节。</strong></p>
  <p style="color:#e53e3e;">请根据您的真实偏好认真作答。</p>
  <button onclick="startFormalExperiment()">开始正式实验</button>
</div>

<div id="rest">
  <h2>请稍作休息</h2>
  <p style="font-size:24px; color:#e53e3e;">您已完成一组题目，请休息片刻。</p>
  <p id="countdownText">1:00</p>
  <p style="font-size:20px; color:#718096;">倒计时结束后请点击下方按钮继续实验</p>
  <button id="continueButton" onclick="resumeAfterRest()" style="display:none; margin-top:20px;">开始答题</button>
</div>

<div id="experimentContainer">
  <div class="panel" id="questionArea">
    <div class="question-header">
      <div id="instructionText">请根据您的真实感受点击您更偏好的选项</div>
      <div id="progressText"></div>
    </div>

    <div class="options-container">
      <div class="option-container">
        <div class="label">选项 A</div>
        <div class="option" id="optA" onclick="chooseAndNext('A')"></div>
      </div>
      <div class="option-container">
        <div class="label">选项 B</div>
        <div class="option" id="optB" onclick="chooseAndNext('B')"></div>
      </div>
    </div>
  </div>

  <div style="text-align:center; margin-top:20px; color:#a0aec0; font-size:18px;">
    (点击选项即可自动进入下一题)
  </div>
</div>

<div id="finish">
  <h2>实验已完成！</h2>
  <p>感谢您的认真参与！</p>
  <p><strong>请将数据文件保存到本地并将数据上传到问卷“选择文件”端口。</strong></p>
  <button onclick="downloadData()">下载实验数据</button>
</div>

<script>
// ===== 练习题（6题）=====
const practiceTrials = [
  { delayMonth: 1, A_now: 10, A_delay: 0, B_now: 0, B_delay: 11 },
  { delayMonth: 1, A_now: -10, A_delay: 0, B_now: 0, B_delay: -11 },
  { delayMonth: 3, A_now: 50, A_delay: 0, B_now: 0, B_delay: 55 },
  { delayMonth: 3, A_now: -30, A_delay: 0, B_now: 0, B_delay: -33 },
  { delayMonth: 1, A_now: 0, A_delay: 20, B_now: 18, B_delay: 0 },
  { delayMonth: 3, A_now: 0, A_delay: -40, B_now: -35, B_delay: 0 }
];

// ===== 正式题（144题）=====
const formalTrialsRaw = [
  // 1个月延迟 获得
  {delayMonth:1, A_now:20, A_delay:0, B_now:15, B_delay:5},
  {delayMonth:1, A_now:20, A_delay:0, B_now:16, B_delay:4},
  {delayMonth:1, A_now:20, A_delay:0, B_now:18, B_delay:2},
  {delayMonth:1, A_now:20, A_delay:0, B_now:19, B_delay:1},
  {delayMonth:1, A_now:20, A_delay:0, B_now:25, B_delay:-5},
  {delayMonth:1, A_now:20, A_delay:0, B_now:26, B_delay:-6},
  {delayMonth:1, A_now:20, A_delay:0, B_now:30, B_delay:-10},
  {delayMonth:1, A_now:20, A_delay:0, B_now:35, B_delay:-15},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:-5, B_delay:-15},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:-6, B_delay:-14},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:-8, B_delay:-12},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:-9, B_delay:-11},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:5, B_delay:-25},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:6, B_delay:-26},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:10, B_delay:-30},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:15, B_delay:-35},
  {delayMonth:1, A_now:40, A_delay:0, B_now:30, B_delay:10},
  {delayMonth:1, A_now:40, A_delay:0, B_now:32, B_delay:8},
  {delayMonth:1, A_now:40, A_delay:0, B_now:36, B_delay:4},
  {delayMonth:1, A_now:40, A_delay:0, B_now:38, B_delay:2},
  {delayMonth:1, A_now:40, A_delay:0, B_now:50, B_delay:-10},
  {delayMonth:1, A_now:40, A_delay:0, B_now:52, B_delay:-12},
  {delayMonth:1, A_now:40, A_delay:0, B_now:60, B_delay:-20},
  {delayMonth:1, A_now:40, A_delay:0, B_now:70, B_delay:-30},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:-10, B_delay:-30},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:-12, B_delay:-28},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:-16, B_delay:-24},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:-18, B_delay:-22},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:10, B_delay:-50},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:12, B_delay:-52},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:20, B_delay:-60},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:30, B_delay:-70},
  {delayMonth:1, A_now:60, A_delay:0, B_now:45, B_delay:15},
  {delayMonth:1, A_now:60, A_delay:0, B_now:48, B_delay:12},
  {delayMonth:1, A_now:60, A_delay:0, B_now:54, B_delay:6},
  {delayMonth:1, A_now:60, A_delay:0, B_now:57, B_delay:3},
  {delayMonth:1, A_now:60, A_delay:0, B_now:75, B_delay:-15},
  {delayMonth:1, A_now:60, A_delay:0, B_now:78, B_delay:-18},
  {delayMonth:1, A_now:60, A_delay:0, B_now:90, B_delay:-30},
  {delayMonth:1, A_now:60, A_delay:0, B_now:105, B_delay:-45},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:-15, B_delay:-45},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:-18, B_delay:-42},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:-24, B_delay:-36},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:-27, B_delay:-33},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:15, B_delay:-75},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:18, B_delay:-78},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:30, B_delay:-90},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:45, B_delay:-105},
  {delayMonth:1, A_now:80, A_delay:0, B_now:60, B_delay:20},
  {delayMonth:1, A_now:80, A_delay:0, B_now:64, B_delay:16},
  {delayMonth:1, A_now:80, A_delay:0, B_now:72, B_delay:8},
  {delayMonth:1, A_now:80, A_delay:0, B_now:76, B_delay:4},
  {delayMonth:1, A_now:80, A_delay:0, B_now:100, B_delay:-20},
  {delayMonth:1, A_now:80, A_delay:0, B_now:104, B_delay:-24},
  {delayMonth:1, A_now:80, A_delay:0, B_now:120, B_delay:-40},
  {delayMonth:1, A_now:80, A_delay:0, B_now:140, B_delay:-60},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:-20, B_delay:-60},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:-24, B_delay:-56},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:-32, B_delay:-48},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:-36, B_delay:-44},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:20, B_delay:-100},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:24, B_delay:-104},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:40, B_delay:-120},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:60, B_delay:-140},
  {delayMonth:1, A_now:20, A_delay:0, B_now:0, B_delay:26},
  {delayMonth:1, A_now:40, A_delay:0, B_now:0, B_delay:40},
  {delayMonth:1, A_now:60, A_delay:0, B_now:0, B_delay:60},
  {delayMonth:1, A_now:80, A_delay:0, B_now:0, B_delay:80},
  {delayMonth:1, A_now:0, A_delay:-20, B_now:-16, B_delay:0},
  {delayMonth:1, A_now:0, A_delay:-40, B_now:-32, B_delay:0},
  {delayMonth:1, A_now:0, A_delay:-60, B_now:-48, B_delay:0},
  {delayMonth:1, A_now:0, A_delay:-80, B_now:-64, B_delay:0},

  // 3个月延迟 获得
  {delayMonth:3, A_now:200, A_delay:0, B_now:150, B_delay:50},
  {delayMonth:3, A_now:200, A_delay:0, B_now:160, B_delay:40},
  {delayMonth:3, A_now:200, A_delay:0, B_now:180, B_delay:20},
  {delayMonth:3, A_now:200, A_delay:0, B_now:190, B_delay:10},
  {delayMonth:3, A_now:200, A_delay:0, B_now:250, B_delay:-50},
  {delayMonth:3, A_now:200, A_delay:0, B_now:260, B_delay:-60},
  {delayMonth:3, A_now:200, A_delay:0, B_now:300, B_delay:-100},
  {delayMonth:3, A_now:200, A_delay:0, B_now:350, B_delay:-150},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:-50, B_delay:-150},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:-60, B_delay:-140},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:-80, B_delay:-120},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:-90, B_delay:-110},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:50, B_delay:-250},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:60, B_delay:-260},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:100, B_delay:-300},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:150, B_delay:-350},
  {delayMonth:3, A_now:400, A_delay:0, B_now:300, B_delay:100},
  {delayMonth:3, A_now:400, A_delay:0, B_now:320, B_delay:80},
  {delayMonth:3, A_now:400, A_delay:0, B_now:360, B_delay:40},
  {delayMonth:3, A_now:400, A_delay:0, B_now:380, B_delay:20},
  {delayMonth:3, A_now:400, A_delay:0, B_now:500, B_delay:-100},
  {delayMonth:3, A_now:400, A_delay:0, B_now:520, B_delay:-120},
  {delayMonth:3, A_now:400, A_delay:0, B_now:600, B_delay:-200},
  {delayMonth:3, A_now:400, A_delay:0, B_now:700, B_delay:-300},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:-100, B_delay:-300},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:-120, B_delay:-280},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:-160, B_delay:-240},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:-180, B_delay:-220},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:100, B_delay:-500},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:120, B_delay:-520},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:200, B_delay:-600},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:300, B_delay:-700},
  {delayMonth:3, A_now:600, A_delay:0, B_now:450, B_delay:150},
  {delayMonth:3, A_now:600, A_delay:0, B_now:480, B_delay:120},
  {delayMonth:3, A_now:600, A_delay:0, B_now:540, B_delay:60},
  {delayMonth:3, A_now:600, A_delay:0, B_now:570, B_delay:30},
  {delayMonth:3, A_now:600, A_delay:0, B_now:750, B_delay:-150},
  {delayMonth:3, A_now:600, A_delay:0, B_now:780, B_delay:-180},
  {delayMonth:3, A_now:600, A_delay:0, B_now:900, B_delay:-300},
  {delayMonth:3, A_now:600, A_delay:0, B_now:1050, B_delay:-450},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:-150, B_delay:-450},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:-180, B_delay:-420},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:-240, B_delay:-360},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:-270, B_delay:-330},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:150, B_delay:-750},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:180, B_delay:-780},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:300, B_delay:-900},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:450, B_delay:-1050},
  {delayMonth:3, A_now:800, A_delay:0, B_now:600, B_delay:200},
  {delayMonth:3, A_now:800, A_delay:0, B_now:640, B_delay:160},
  {delayMonth:3, A_now:800, A_delay:0, B_now:720, B_delay:80},
  {delayMonth:3, A_now:800, A_delay:0, B_now:760, B_delay:40},
  {delayMonth:3, A_now:800, A_delay:0, B_now:1000, B_delay:-200},
  {delayMonth:3, A_now:800, A_delay:0, B_now:1040, B_delay:-240},
  {delayMonth:3, A_now:800, A_delay:0, B_now:1200, B_delay:-400},
  {delayMonth:3, A_now:800, A_delay:0, B_now:1400, B_delay:-600},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:-200, B_delay:-600},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:-240, B_delay:-560},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:-320, B_delay:-480},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:-360, B_delay:-440},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:200, B_delay:-1000},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:240, B_delay:-1040},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:400, B_delay:-1200},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:600, B_delay:-1400},
  {delayMonth:3, A_now:200, A_delay:0, B_now:0, B_delay:260},
  {delayMonth:3, A_now:400, A_delay:0, B_now:0, B_delay:520},
  {delayMonth:3, A_now:600, A_delay:0, B_now:0, B_delay:780},
  {delayMonth:3, A_now:800, A_delay:0, B_now:0, B_delay:1040},
  {delayMonth:3, A_now:0, A_delay:-200, B_now:-160, B_delay:0},
  {delayMonth:3, A_now:0, A_delay:-400, B_now:-320, B_delay:0},
  {delayMonth:3, A_now:0, A_delay:-600, B_now:-480, B_delay:0},
  {delayMonth:3, A_now:0, A_delay:-800, B_now:-640, B_delay:0}
].map((t, i) => ({ ...t, id: i }));

function shuffleArray(array) {
  const arr = [...array];
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

let trials = [];
let responses = [];
let reactionTimes = []; // 记录正式题反应时
let currentIndex = -1;
let pid = "";
let isClickable = true;
let countdownInterval = null;
const REST_INTERVAL = 48;

function generateOptionHTML(nowVal, delayVal, delayMonth) {
  let nowAction = nowVal >= 0 ? "获得" : "支付";
  let nowAmount = Math.abs(nowVal);
  let nowHtml = `现在 <span class="highlight-keyword">${nowAction}</span> <span class="amount-text">${nowAmount}</span> 元`;

  let timeStr = delayMonth === 1 ? "1个月后" : "3个月后";
  let delayAction = delayVal >= 0 ? "获得" : "支付";
  let delayAmount = Math.abs(delayVal);
  let delayHtml = `${timeStr} <span class="highlight-keyword">${delayAction}</span> <span class="amount-text">${delayAmount}</span> 元`;

  return `
    <div class="option-row top">${nowHtml}</div>
    <div class="option-row bottom">${delayHtml}</div>
  `;
}

function startExperiment() {
  pid = document.getElementById("pid").value.trim();
  if (!pid) {
    alert("请输入参与者编号！");
    return;
  }

  const practice = practiceTrials.map(t => ({...t, isPractice: true, swap: false }));
  const formalShuffled = shuffleArray(formalTrialsRaw).map(t => ({
    ...t,
    isPractice: false,
    swap: Math.random() < 0.5
  }));

  trials = [...practice, ...formalShuffled];
  responses = new Array(trials.length).fill(null);
  reactionTimes = new Array(trials.length).fill(null);

  document.getElementById("intro").style.display = "none";
  document.getElementById("experimentContainer").style.display = "block";

  showQuestion(0);
}

function startFormalExperiment() {
  if (countdownInterval) clearInterval(countdownInterval);
  document.getElementById("transition").style.display = "none";
  document.getElementById("experimentContainer").style.display = "block";
  showQuestion(practiceTrials.length);
}

function showQuestion(index) {
  currentIndex = index;
  isClickable = true;
  const trial = trials[index];
  const progressText = document.getElementById("progressText");

  if (trial.isPractice) {
    progressText.textContent = `练习题 ${index + 1} / ${practiceTrials.length}`;
  } else {
    const formalIndex = index - practiceTrials.length + 1;
    const totalFormal = trials.length - practiceTrials.length;
    progressText.textContent = `进度：${formalIndex} / ${totalFormal}`;

    // ✅ 仅正式题记录开始时间
    window.questionStartTime = Date.now();
  }

  const optA = document.getElementById("optA");
  const optB = document.getElementById("optB");
  const labelA = document.querySelector('.option-container:first-child .label');
  const labelB = document.querySelector('.option-container:last-child .label');

  let leftOption, rightOption;
  let leftLabel, rightLabel;

  if (trial.swap && !trial.isPractice) {
    leftOption = generateOptionHTML(trial.B_now, trial.B_delay, trial.delayMonth);
    rightOption = generateOptionHTML(trial.A_now, trial.A_delay, trial.delayMonth);
    leftLabel = "选项 B";
    rightLabel = "选项 A";
  } else {
    leftOption = generateOptionHTML(trial.A_now, trial.A_delay, trial.delayMonth);
    rightOption = generateOptionHTML(trial.B_now, trial.B_delay, trial.delayMonth);
    leftLabel = "选项 A";
    rightLabel = "选项 B";
  }

  optA.innerHTML = leftOption;
  optB.innerHTML = rightOption;
  labelA.textContent = leftLabel;
  labelB.textContent = rightLabel;

  optA.classList.remove("selected");
  optB.classList.remove("selected");
}

function chooseAndNext(choice) {
  if (!isClickable) return;
  isClickable = false;

  const trial = trials[currentIndex];
  let actualChoice;

  if (trial.isPractice) {
    actualChoice = choice;
  } else {
    actualChoice = trial.swap ? (choice === 'A' ? 'B' : 'A') : choice;

    // ✅ 保存反应时
    const rt = Date.now() - window.questionStartTime;
    reactionTimes[currentIndex] = rt;
  }

  responses[currentIndex] = actualChoice;

  document.querySelectorAll(".option").forEach(el => el.classList.remove("selected"));
  document.getElementById(`opt${choice}`).classList.add("selected");

  setTimeout(() => {
    goNext();
  }, 300);
}

function goNext() {
  if (currentIndex === practiceTrials.length - 1) {
    document.getElementById("experimentContainer").style.display = "none";
    document.getElementById("transition").style.display = "block";
    return;
  }

  if (!trials[currentIndex].isPractice) {
    const formalDone = currentIndex - practiceTrials.length + 1;
    const totalFormal = trials.length - practiceTrials.length;
    if (formalDone % REST_INTERVAL === 0 && formalDone < totalFormal) {
      showRestPage();
      return;
    }
  }

  if (currentIndex < trials.length - 1) {
    showQuestion(currentIndex + 1);
  } else {
    finishExperiment();
  }
}

function showRestPage() {
  if (countdownInterval) clearInterval(countdownInterval);

  document.getElementById("experimentContainer").style.display = "none";
  document.getElementById("rest").style.display = "block";
  document.getElementById("continueButton").style.display = "none"; // 初始隐藏

  let seconds = 60;
  const countdownText = document.getElementById("countdownText");

  function updateCountdown() {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    countdownText.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;

    if (seconds <= 0) {
      clearInterval(countdownInterval);
      // ✅ 倒计时结束，显示“开始答题”按钮
      document.getElementById("continueButton").style.display = "inline-block";
    } else {
      seconds--;
    }
  }

  updateCountdown();
  countdownInterval = setInterval(updateCountdown, 1000);
}

function resumeAfterRest() {
  document.getElementById("rest").style.display = "none";
  document.getElementById("experimentContainer").style.display = "block";

  if (currentIndex + 1 < trials.length) {
    showQuestion(currentIndex + 1); // 此刻才开始下一题，并记录 RT
  } else {
    finishExperiment();
  }
}

function finishExperiment() {
  document.getElementById("experimentContainer").style.display = "none";
  document.getElementById("finish").style.display = "block";
}

function downloadData() {
  let csv = "participant_id,trial_index,delay_month,A_now,A_delay,B_now,B_delay,choice,reaction_time_ms\n";

  const responseMap = new Map();
  const rtMap = new Map();

  for (let i = practiceTrials.length; i < trials.length; i++) {
    const trial = trials[i];
    const choice = responses[i] || "none";
    const rt = reactionTimes[i] || -1;
    responseMap.set(trial.id, choice);
    rtMap.set(trial.id, rt);
  }

  for (let i = 0; i < formalTrialsRaw.length; i++) {
    const t = formalTrialsRaw[i];
    const choice = responseMap.get(t.id) || "missing";
    const rt = rtMap.get(t.id) || -1;
    csv += `"${pid}",${i + 1},${t.delayMonth},${t.A_now},${t.A_delay},${t.B_now},${t.B_delay},${choice},${rt}\n`;
  }

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${pid}_time_choice_data.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
